name: Python SDK Publish to PyPI

on:
  push:
    branches: [master, develop]
    paths: ['py-sdk/**']

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Determine versions
        id: versions
        run: |
          # Read base versions from VERSION files
          BHARATML_VERSION=$(cat py-sdk/bharatml_commons/VERSION | tr -d '\n' | tr -d ' ')
          SPARK_VERSION=$(cat py-sdk/spark_feature_push_client/VERSION | tr -d '\n' | tr -d ' ')
          GRPC_VERSION=$(cat py-sdk/grpc_feature_client/VERSION | tr -d '\n' | tr -d ' ')
          
          # Strip 'v' prefix if present
          BHARATML_VERSION=${BHARATML_VERSION#v}
          SPARK_VERSION=${SPARK_VERSION#v}
          GRPC_VERSION=${GRPC_VERSION#v}
          
          # Add beta suffix for develop branch
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            BHARATML_VERSION="${BHARATML_VERSION}-beta"
            SPARK_VERSION="${SPARK_VERSION}-beta"
            GRPC_VERSION="${GRPC_VERSION}-beta"
          fi
          
          echo "bharatml_version=$BHARATML_VERSION" >> $GITHUB_OUTPUT
          echo "spark_version=$SPARK_VERSION" >> $GITHUB_OUTPUT
          echo "grpc_version=$GRPC_VERSION" >> $GITHUB_OUTPUT
          
          echo "bharatml-commons version: $BHARATML_VERSION"
          echo "spark-feature-push-client version: $SPARK_VERSION"
          echo "grpc-feature-client version: $GRPC_VERSION"

      - name: Build all packages
        run: |
          # Create consolidated dist directory
          mkdir -p dist
          rm -rf dist/*
          
          # Build bharatml_commons
          cd py-sdk/bharatml_commons
          rm -rf dist/ build/ *.egg-info/
          python -m build
          cp dist/* ../../dist/
          cd ../..
          
          # Build spark_feature_push_client  
          cd py-sdk/spark_feature_push_client
          rm -rf dist/ build/ *.egg-info/
          python -m build
          cp dist/* ../../dist/
          cd ../..
          
          # Build grpc_feature_client
          cd py-sdk/grpc_feature_client
          rm -rf dist/ build/ *.egg-info/
          python -m build
          cp dist/* ../../dist/
          cd ../..
          
          echo "📦 Built packages:"
          ls -la dist/

      - name: Test package installations
        run: |
          pip install dist/*.whl --force-reinstall --find-links dist/
          
          python -c "
          import bharatml_commons
          import spark_feature_push_client
          import grpc_feature_client
          print('✓ All packages imported successfully')
          "

      - name: Publish to TestPyPI (develop branch)
        if: github.ref == 'refs/heads/develop'
        run: |
          twine upload --repository testpypi dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}

      - name: Publish to PyPI (master branch)
        if: github.ref == 'refs/heads/master'
        run: |
          twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}

      - name: Generate summary
        run: |
          echo "## 🐍 Python SDK Published Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Published to:** ${{ github.ref == 'refs/heads/develop' && 'TestPyPI' || 'PyPI' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📦 Package Versions:" >> $GITHUB_STEP_SUMMARY
          echo "- **bharatml-commons**: \`${{ steps.versions.outputs.bharatml_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **spark-feature-push-client**: \`${{ steps.versions.outputs.spark_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **grpc-feature-client**: \`${{ steps.versions.outputs.grpc_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔗 Links:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "- **TestPyPI bharatml-commons**: https://test.pypi.org/project/bharatml-commons/" >> $GITHUB_STEP_SUMMARY
            echo "- **TestPyPI spark-feature-push-client**: https://test.pypi.org/project/spark-feature-push-client/" >> $GITHUB_STEP_SUMMARY
            echo "- **TestPyPI grpc-feature-client**: https://test.pypi.org/project/grpc-feature-client/" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **PyPI bharatml-commons**: https://pypi.org/project/bharatml-commons/" >> $GITHUB_STEP_SUMMARY
            echo "- **PyPI spark-feature-push-client**: https://pypi.org/project/spark-feature-push-client/" >> $GITHUB_STEP_SUMMARY
            echo "- **PyPI grpc-feature-client**: https://pypi.org/project/grpc-feature-client/" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Installation:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "# Install from TestPyPI" >> $GITHUB_STEP_SUMMARY
            echo "pip install --index-url https://test.pypi.org/simple/ bharatml-commons==${{ steps.versions.outputs.bharatml_version }}" >> $GITHUB_STEP_SUMMARY
            echo "pip install --index-url https://test.pypi.org/simple/ spark-feature-push-client==${{ steps.versions.outputs.spark_version }}" >> $GITHUB_STEP_SUMMARY
            echo "pip install --index-url https://test.pypi.org/simple/ grpc-feature-client==${{ steps.versions.outputs.grpc_version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "# Install from PyPI" >> $GITHUB_STEP_SUMMARY
            echo "pip install bharatml-commons==${{ steps.versions.outputs.bharatml_version }}" >> $GITHUB_STEP_SUMMARY
            echo "pip install spark-feature-push-client==${{ steps.versions.outputs.spark_version }}" >> $GITHUB_STEP_SUMMARY
            echo "pip install grpc-feature-client==${{ steps.versions.outputs.grpc_version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY 