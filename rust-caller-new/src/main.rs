use axum::{extract::State, http::StatusCode, response::Json, routing::post, Router};
use std::{sync::Arc, time::Duration};
use tonic::{metadata::AsciiMetadataValue, transport::{Channel, Endpoint}};

pub mod retrieve {
    tonic::include_proto!("retrieve");
}

use retrieve::feature_service_client::FeatureServiceClient as RetrieveClient;
use retrieve::{FeatureGroup, Keys, Query};

#[derive(Clone)]
struct AppState {
    client: RetrieveClient<Channel>,
    entity_label: String,
    feature_group: FeatureGroup,
    keys_schema: Vec<String>,
    auth_token: AsciiMetadataValue,
    caller_id: AsciiMetadataValue,
}

async fn retrieve_features(
    State(state): State<Arc<AppState>>,
) -> Result<Json<&'static str>, StatusCode> {

    let query = Query {
        entity_label: state.entity_label.clone(),
        feature_groups: vec![state.feature_group.clone()],
        keys_schema: state.keys_schema.clone(),
        keys: vec![
            Keys { cols: vec!["176".to_string()] },
            Keys { cols: vec!["179".to_string()] },
        ],
    };

    let mut request = tonic::Request::new(query);
    request.set_timeout(Duration::from_secs(5));

    request.metadata_mut().insert(
        "online-feature-store-auth-token",
        state.auth_token.clone(),
    );
    request.metadata_mut().insert(
        "online-feature-store-caller-id",
        state.caller_id.clone(),
    );

    match state.client.clone().retrieve_features(request).await {
        Ok(_) => Ok(Json("success")),
        Err(_) => Err(StatusCode::INTERNAL_SERVER_ERROR),
    }
}


fn get_labels() -> Vec<String> {
    vec!["max_product_price_percentile".to_string(), "orders_by_views_56day_percentile".to_string(), "catalog__platform_orders_by_clicks_28_days_percentile_bin".to_string(), "orders_by_views_28day_bin_percentile".to_string(), "min_product_price_percentile".to_string(), "orders_14day_percentile".to_string(), "total_rated_orders_bin_percentile".to_string(), "orders_28day_percentile".to_string(), "clicks_by_views_1day_percentile".to_string(), "min_product_price_bin_percentile".to_string(), "clicks_by_views_3day_percentile".to_string(), "log_orders_1day".to_string(), "total_rated_orders_percentile".to_string(), "clicks_by_views_5day".to_string(), "views_56day_percentile".to_string(), "log_clicks_7day".to_string(), "views_3day_percentile".to_string(), "orders_by_views_28day_percentile".to_string(), "orders_7day_percentile".to_string(), "orders_by_clicks_14day_percentile".to_string(), "clicks_by_views_5day_percentile".to_string(), "log_clicks_56day".to_string(), "orders_by_clicks_28day_percentile".to_string(), "orders_3day_percentile".to_string(), "clicks_by_views_56day_percentile".to_string(), "log_orders_14day".to_string(), "log_views_5day".to_string(), "max_product_price_percentile_bin".to_string(), "log_clicks_3day".to_string(), "views_7day_percentile".to_string(), "orders_by_views_14day_percentile".to_string(), "log_clicks_28day".to_string(), "log_views_1day".to_string(), "log_orders_7day".to_string(), "clicks_by_views_1day__bin_percentile".to_string(), "clicks_56day_percentile".to_string(), "clicks_5day_percentile".to_string(), "catalog__platform_orders_by_clicks_3_days".to_string(), "orders_by_clicks_3day_percentile".to_string(), "orders_by_clicks_1day_percentile".to_string(), "orders_by_clicks_5day_percentile".to_string(), "log_clicks_1day".to_string(), "orders_by_clicks_7day_percentile".to_string(), "log_orders_3day".to_string(), "log_orders_56day".to_string(), "clicks_7day_percentile".to_string(), "orders_by_views_3day_percentile".to_string(), "log_views_56day".to_string(), "clicks_3day_percentile".to_string(), "orders_by_views_7day_percentile".to_string(), "clicks_1day_percentile".to_string(), "orders_by_views_5day_percentile".to_string(), "log_clicks_14day".to_string(), "clicks_by_views_7day_percentile".to_string(), "clicks_28day_percentile".to_string(), "orders_5day_percentile".to_string(), "orders_by_views_1day_percentile".to_string(), "log_orders_28day".to_string(), "clicks_by_views_28day_bin_percentile".to_string(), "log_views_7day".to_string(), "views_5day_percentile".to_string(), "views_28day_percentile".to_string(), "log_views_28day".to_string(), "views_1day_percentile".to_string(), "orders_1day_percentile".to_string(), "log_views_3day".to_string(), "orders_by_clicks_56day_percentile".to_string(), "log_clicks_5day".to_string(), "orders_56day_percentile".to_string(), "clicks_by_views_14day_percentile".to_string(), "clicks_by_views_28day_percentile".to_string(), "ctr_bin_normalized_clicks_by_views_1_days".to_string(), "sscat_normalized_clicks_by_views_1_days".to_string(), "position_coec_7_days".to_string(), "pdp__hour_coec_7_days".to_string(), "hour_coec_1_days".to_string(), "pdp__sscat_normalized_clicks_by_views_7_days".to_string(), "search__clicks_by_views_1_days".to_string(), "pdp__position_coec_7_days".to_string(), "search__clicks_by_views_3_days".to_string(), "hour_coec_30_days".to_string(), "search__active_days_normalized_clicks_by_views_3_days".to_string(), "pdp__clicks_by_views_7_days".to_string(), "clicks_by_views_14_days".to_string(), "hour_coec_14_days".to_string(), "search__sscat_normalized_clicks_by_views_1_days".to_string(), "search__hour_coec_1_days".to_string(), "clicks_by_views_30_days".to_string(), "position_coec_3_days".to_string(), "search__active_days_normalized_clicks_by_views_1_days".to_string(), "search__position_coec_7_days".to_string(), "clicks_by_active_days_14_days".to_string(), "search__clicks_by_active_days_7_days".to_string(), "pdp__hour_coec_14_days".to_string(), "search__active_days_normalized_clicks_by_views_7_days".to_string(), "search__hour_coec_14_days".to_string(), "hour_expected_clicks_1_days".to_string(), "position_coec_14_days".to_string(), "search__clicks_by_views_7_days".to_string(), "search__hour_coec_3_days".to_string(), "position_expected_clicks_1_days".to_string(), "clicks_by_views_3_days".to_string(), "pdp__sscat_normalized_clicks_by_views_30_days".to_string(), "search__position_coec_30_days".to_string(), "pdp__clicks_by_active_days_7_days".to_string(), "search__position_coec_3_days".to_string(), "search__active_days_normalized_clicks_by_views_14_days".to_string(), "search__clicks_by_views_14_days".to_string(), "pdp__clicks_by_views_1_days".to_string(), "search__sscat_normalized_clicks_by_views_30_days".to_string(), "pdp__clicks_by_views_14_days".to_string(), "hour_coec_7_days".to_string(), "pdp__hour_coec_30_days".to_string(), "search__hour_coec_7_days".to_string(), "search__sscat_normalized_clicks_by_views_7_days".to_string(), "sscat_normalized_clicks_by_views_7_days".to_string(), "pdp__clicks_by_views_3_days".to_string(), "search__position_coec_1_days".to_string(), "search__sscat_normalized_clicks_by_views_14_days".to_string(), "search__clicks_by_views_30_days".to_string(), "clicks_by_views_1_days".to_string(), "pdp__position_coec_30_days".to_string(), "clicks_by_views_7_days".to_string(), "position_coec_1_days".to_string(), "pdp__hour_coec_1_days".to_string(), "search__hour_coec_30_days".to_string(), "sscat_normalized_clicks_by_views_30_days".to_string(), "search__sscat_normalized_clicks_by_views_3_days".to_string(), "position_coec_30_days".to_string(), "pdp__clicks_by_views_30_days".to_string(), "orders_by_clicks_laplace_28day".to_string(), "clicks_by_views_laplace_7day".to_string(), "orders_by_views_laplace_1day".to_string(), "clicks_by_views_laplace_3day".to_string(), "clicks_by_views_laplace_56day".to_string(), "catalog__ads_orders_by_clicks_14_days__te_laplace".to_string(), "orders_by_clicks_laplace_3day".to_string(), "orders_by_views_laplace_28day".to_string(), "orders_by_clicks_laplace_56day".to_string(), "orders_by_clicks_laplace_7day".to_string(), "orders_by_views_laplace_5day".to_string(), "clicks_by_views_laplace_5day".to_string(), "orders_by_views_laplace_3day".to_string(), "orders_by_views_laplace_56day".to_string(), "catalog__ads_orders_by_views_14_days__te_laplace".to_string(), "orders_by_clicks_laplace_5day".to_string(), "clicks_by_views_laplace_1day".to_string(), "orders_by_clicks_laplace_1day".to_string(), "orders_by_views_laplace_7day".to_string(), "clicks_by_views_laplace_28day".to_string(), "laplace_cbyv_by_platform_cbyv_7day".to_string(), "laplace_cbyv_by_platform_cbyv_56day".to_string(), "laplace_obyv_by_platform_obyv_1day".to_string(), "laplace_cbyv_by_platform_cbyv_3day".to_string(), "laplace_obyv_by_platform_obyv_56day".to_string(), "laplace_obyc_by_platform_obyc_56day".to_string(), "laplace_obyc_by_platform_obyc_7day".to_string(), "laplace_obyv_by_platform_obyv_5day".to_string(), "laplace_obyc_by_platform_obyc_3day".to_string(), "laplace_obyc_by_platform_obyc_28day".to_string(), "laplace_obyv_by_platform_obyv_28day".to_string(), "laplace_cbyv_by_platform_cbyv_5day".to_string(), "laplace_obyc_by_platform_obyc_5day".to_string(), "laplace_cbyv_by_platform_cbyv_1day".to_string(), "laplace_cbyv_by_platform_cbyv_28day".to_string(), "laplace_obyv_by_platform_obyv_3day".to_string(), "catalog__base_cpc".to_string(), "laplace_obyv_by_platform_obyv_7day".to_string(), "laplace_obyc_by_platform_obyc_1day".to_string(), "orders_by_views_3_days_percentile".to_string(), "views_7_days_percentile".to_string(), "orders_by_clicks_56_days_percentile".to_string(), "orders_by_clicks_5_days_percentile".to_string(), "clicks_by_views_28_days_percentile".to_string(), "orders_1_days__te_log".to_string(), "search__orders_by_views_3_days_percentile".to_string(), "orders_3_days__te_log".to_string(), "orders_1_days_percentile".to_string(), "orders_7_days_percentile".to_string(), "orders_7_days__te_log".to_string(), "search__orders_by_clicks_3_days_percentile".to_string(), "search__clicks_by_views_1_days_percentile_bin".to_string(), "search__clicks_56_days_percentile".to_string(), "search__orders_by_views_28_days_percentile_bin".to_string(), "orders_by_views_7_days_percentile_bin".to_string(), "orders_by_clicks_3_days_percentile".to_string(), "search__clicks_by_views_1_days_percentile".to_string(), "search__orders_by_clicks_1_days_percentile_bin".to_string(), "orders_by_views_14_days_percentile".to_string(), "search__orders_by_views_28_days_percentile".to_string(), "search__orders_by_views_56_days_percentile_bin".to_string(), "orders_by_views_1_days_percentile".to_string(), "orders_by_clicks_14_days_percentile".to_string(), "search__orders_by_views_14_days_percentile".to_string(), "search__orders_by_views_1_days_percentile".to_string(), "clicks_by_views_14_days_percentile".to_string(), "search__orders_by_views_5_days_percentile_bin".to_string(), "clicks_3_days_percentile".to_string(), "clicks_by_views_3_days_percentile".to_string(), "orders_by_clicks_28_days_percentile".to_string(), "search__orders_by_clicks_56_days_percentile".to_string(), "search__clicks_by_views_28_days_percentile".to_string(), "search__orders_by_clicks_7_days_percentile_bin".to_string(), "search__clicks_by_views_14_days_percentile_bin".to_string(), "orders_by_clicks_7_days".to_string(), "orders_by_clicks_3_days_percentile_bin".to_string(), "orders_by_views_3_days_percentile_bin".to_string(), "views_28_days_percentile".to_string(), "clicks_by_views_7_days_percentile".to_string(), "clicks_by_views_1_days_percentile".to_string(), "clicks_56_days__te_log".to_string(), "orders_by_views_28_days_percentile".to_string(), "search__orders_by_clicks_7_days_percentile".to_string(), "search__orders_by_clicks_1_days_percentile".to_string(), "orders_by_clicks_1_days_percentile".to_string(), "orders_by_clicks_7_days_percentile".to_string(), "orders_by_views_5_days_percentile".to_string(), "search__orders_by_views_14_days_percentile_bin".to_string(), "search__orders_by_clicks_3_days_percentile_bin".to_string(), "search__orders_by_views_5_days_percentile".to_string(), "clicks_7_days_percentile".to_string(), "views_56_days_percentile_bin".to_string(), "orders_by_clicks_7_days_percentile_bin".to_string(), "search__orders_1_days_percentile".to_string(), "clicks_28_days__te_log".to_string(), "orders_by_views_56_days_percentile".to_string(), "orders_by_clicks_1_days_percentile_bin".to_string(), "search__orders_by_views_56_days_percentile".to_string(), "views_3_days_percentile".to_string(), "orders_by_views_7_days_percentile".to_string(), "search__orders_by_views_7_days_percentile".to_string(), "clicks_28_days_percentile".to_string(), "search__orders_by_views_1_days_percentile_bin".to_string(), "orders_3_days_percentile".to_string(), "orders_28_days_percentile".to_string(), "clicks_by_views_56_days_percentile".to_string(), "num_rating_3_By_num_rating".to_string(), "qr_orders_by_sub_orders_28day".to_string(), "num_rating_4_By_num_rating".to_string(), "catalog__nqd_28_days".to_string(), "catalog__num_rating_3_By_num_rating_56_days".to_string(), "rtos_by_net_orders".to_string(), "nqp_28day".to_string(), "net_orders_by_gross_orders_28day".to_string(), "catalog__qr_orders_By_return_orders_90_days".to_string(), "rating_avg".to_string(), "rtos_by_gross_orders".to_string(), "net_orders_by_gross_orders_90day".to_string(), "num_review_By_num_rating".to_string(), "catalog__wfr_orders_By_return_orders".to_string(), "catalog__num_rating_3_By_num_rating_90_days".to_string(), "catalog__mean_price_90_days".to_string(), "rtos_by_net_orders_90day".to_string(), "catalog__num_rating_3_By_num_rating_28_days".to_string(), "num_img_review_by_num_review".to_string(), "avg_ratings_7day".to_string(), "num_review_By_num_rating_7day".to_string(), "nqp_by_nqd_90day".to_string(), "nqp".to_string(), "nqd".to_string(), "catalog__avg_ratings_28_days".to_string(), "net_orders_by_gross_orders_56day".to_string(), "catalog__nqp_90_days".to_string(), "user_cancelled_by_net_orders_7day".to_string(), "return_orders_by_sub_orders".to_string(), "cancellations_by_gross_orders_90day".to_string(), "cancellations_by_net_orders_7day".to_string(), "qr_orders_by_sub_orders".to_string(), "catalog__total_helpful_review_By_num_review".to_string(), "catalog__total_o2d_delay_By_total_orders_28_days".to_string(), "return_orders_by_sub_orders_90day".to_string(), "nqp_By_nqd_7day".to_string(), "nqp_by_nqd_28day".to_string(), "catalog__user_cancelled_By_net_orders".to_string(), "cancellations_by_net_orders_56day".to_string(), "catalog__num_rating_4_By_num_rating_7_days".to_string(), "catalog__net_orders_By_gross_orders_7_days".to_string(), "rtos_by_gross_orders_28day".to_string(), "avg_ratings_56day".to_string(), "total_s2d_delay_by_total_orders_28day".to_string(), "nqp_by_nqd".to_string(), "num_rating_5_by_num_rating".to_string(), "count_reviews_with_helpful_by_num_review_28day".to_string(), "rtos_by_gross_orders_56day".to_string(), "user_cancelled_by_net_orders_28day".to_string(), "catalog__return_orders_By_sub_orders_28_days".to_string(), "wfr_orders_by_sub_orders".to_string(), "num_review_by_num_rating_28day".to_string(), "wfr_orders_by_sub_orders_28day".to_string(), "num_review_by_num_rating_90day".to_string(), "catalog__num_rating_1_By_num_rating_5_56_days".to_string(), "catalog__num_rating_3_By_num_rating_7_days".to_string(), "nqp_7day".to_string(), "sscat_standardized_cat_predicted_nqd_wd_sigmoid".to_string(), "net_orders_by_gross_orders".to_string(), "cancellations_by_net_orders".to_string(), "return_orders_by_sub_orders_56day".to_string(), "cancellations_by_gross_orders".to_string(), "catalog__rtos_By_gross_orders_7_days".to_string(), "catalog__total_o2d_delay_By_total_orders".to_string(), "catalog__total_o2s_delayed_orders_By_total_orders_56_days".to_string(), "catalog__nqd_7_days".to_string(), "catalog__num_rating_5_By_num_rating_7_days".to_string(), "user_cancelled_by_net_orders_56day".to_string(), "cancellations_by_net_orders_28day".to_string(), "sscat__price_asp".to_string(), "asp_sscat_percentile".to_string(), "price_shipping_percent".to_string(), "price_cheapest_duplicate_diff_percent".to_string(), "sscat_asp_price_arp_diff_percent".to_string(), "price_wdrp_depth_percent".to_string(), "price_sscat_percentile".to_string(), "price_decrease_percent_decay".to_string(), "arp_sscat_percentile".to_string(), "price_discount_percent".to_string(), "catalog__price_decrease_pct".to_string(), "mrp_sscat_percentile".to_string(), "price_increase_percent_decay".to_string(), "sscat_asp_price_arp_diff".to_string(), "price_discount".to_string(), "catalog__user_risk_weighted_orders_90_days".to_string(), "od_between_25p_to_50p_user_api_user_orders_percentage_90day".to_string(), "high_risk_user_orders_percentage".to_string(), "od_less_than_25p_user_api_user_orders_percentage_90day".to_string(), "od_2_4_order_users_orders_percentage_90day".to_string(), "od_more_than_75p_user_aov_user_orders_percentage_90day".to_string(), "od_20_plus_order_users_orders_percentage_90day".to_string(), "avg_orders_weighted_aov_90day".to_string(), "low_risk_user_orders_percentage".to_string(), "od_5_10_order_users_orders_percentage".to_string(), "od_2_4_order_users_orders_percentage".to_string(), "low_risk_user_orders_percentage_90day".to_string(), "od_10_20_order_users_orders_percentage".to_string(), "catalog__between_50p_to_75p_user_aov_user_orders_percentage_90_days".to_string(), "od_0_1_order_users_orders_percentage_90day".to_string(), "avg_orders_weighted_api_90day".to_string(), "od_less_than_25p_user_aov_user_orders_percentage_90day".to_string(), "od_0_1_order_users_orders_percentage".to_string(), "od_5_10_order_users_orders_percentage_90day".to_string(), "od_between_25p_to_50p_user_aov_user_orders_percentage_90day".to_string(), "od_more_than_75p_user_api_user_orders_percentage_90day".to_string(), "od_between_50p_to_75p_user_api_user_orders_percentage_90day".to_string(), "catalog__high_risk_user_orders_percentage_90_days".to_string(), "od_20_plus_order_users_orders_percentage".to_string(), "catalog__10_20_order_users_orders_percentage_90_days".to_string(), "catalog__ads_clicks_by_views_56_days_percentile".to_string(), "catalog__ads_orders_by_views_1_days_percentile_bin".to_string(), "catalog__ads_orders_by_views_56_days_percentile_bin".to_string(), "catalog__ads_clicks_by_views_28_days_percentile".to_string(), "catalog__ads_orders_by_views_14_days_percentile_bin".to_string(), "clicks_28day_percentile".to_string(), "catalog__ads_orders_by_views_3_days_percentile".to_string(), "catalog__ads_clicks_by_views_28_days_percentile_bin".to_string(), "catalog__ads_orders_by_clicks_5_days_percentile".to_string(), "orders_56day_percentile".to_string(), "catalog__ads_orders_14_days_percentile".to_string(), "clicks_56day_percentile".to_string(), "catalog__ads_clicks_by_views_5_days".to_string(), "catalog__ads_orders_by_views_7_days_percentile".to_string(), "views_1day_percentile".to_string(), "catalog__ads_orders_by_clicks_28_days_percentile_bin".to_string(), "catalog__ads_orders_by_clicks_7_days_percentile_bin".to_string(), "catalog__ads_orders_by_views_56_days_percentile".to_string(), "clicks_7day_percentile".to_string(), "catalog__ads_orders_by_views_7_days_percentile_bin".to_string(), "clicks_3day_percentile".to_string(), "catalog__ads_orders_by_views_28_days_percentile_bin".to_string(), "catalog__ads_orders_by_clicks_1_days_percentile_bin".to_string(), "views_56day_percentile".to_string(), "catalog__ads_orders_by_clicks_56_days_percentile_bin".to_string(), "views_5day_percentile".to_string(), "catalog__ads_clicks_by_views_3_days_percentile_bin".to_string(), "catalog__ads_orders_by_clicks_7_days_percentile".to_string(), "catalog__ads_orders_by_views_28_days_percentile".to_string(), "catalog__ads_clicks_by_views_7_days_percentile".to_string(), "catalog__ads_orders_by_clicks_3_days_percentile".to_string(), "catalog__ads_clicks_by_views_1_days_percentile".to_string(), "catalog__ads_orders_by_clicks_3_days_percentile_bin".to_string(), "catalog__ads_orders_by_clicks_56_days_percentile".to_string(), "catalog__ads_orders_by_clicks_28_days_percentile".to_string(), "catalog__ads_orders_by_clicks_14_days".to_string(), "catalog__ads_clicks_by_views_14_days_percentile_bin".to_string(), "orders_3day_percentile".to_string(), "catalog__ads_orders_by_clicks_14_days_percentile".to_string(), "orders_1day_percentile".to_string(), "views_28day_percentile".to_string(), "catalog__ads_clicks_by_views_1_days_percentile_bin".to_string(), "orders_5day_percentile".to_string(), "catalog__ads_clicks_by_views_5_days_percentile_bin".to_string(), "orders_28day_percentile".to_string(), "catalog__ads_orders_by_views_5_days_percentile".to_string(), "orders_7day_percentile".to_string(), "catalog__ads_orders_by_views_5_days_percentile_bin".to_string(), "catalog__ads_orders_by_views_1_days_percentile".to_string(), "catalog__ads_clicks_by_views_56_days_percentile_bin".to_string(), "catalog__ads_clicks_by_views_14_days_percentile".to_string(), "catalog__ads_orders_by_views_14_days_percentile".to_string(), "views_3day_percentile".to_string(), "clicks_5day_percentile".to_string(), "catalog__ads_clicks_by_views_56_days".to_string(), "catalog__ads_clicks_by_views_5_days_percentile".to_string(), "catalog__ads_orders_by_views_3_days_percentile_bin".to_string(), "clicks_1day_percentile".to_string(), "views_7day_percentile".to_string(), "catalog__ads_orders_by_clicks_5_days_percentile_bin".to_string(), "catalog__ads_clicks_by_views_3_days_percentile".to_string(), "catalog__ads_clicks_by_views_7_days_percentile_bin".to_string(), "catalog__ads_orders_by_clicks_1_days_percentile".to_string(), "catalog__ads_orders_by_clicks_14_days_percentile_bin".to_string(), "search__orders_by_views_7_days_percentile".to_string(), "search__orders_by_clicks_1_days_percentile_bin".to_string(), "search__orders_by_views_1_days_percentile".to_string(), "search__orders_by_views_28_days_percentile_bin".to_string(), "search__clicks_by_views_3_days_percentile".to_string(), "search__orders_by_clicks_7_days_percentile".to_string(), "search__orders_by_views_5_days_percentile_bin".to_string(), "search__orders_by_views_14_days_percentile_bin".to_string(), "search__orders_by_clicks_7_days_percentile_bin".to_string(), "search__orders_by_views_3_days_percentile".to_string(), "search__clicks_by_views_14_days_percentile_bin".to_string(), "search__clicks_by_views_14_days_percentile".to_string(), "search__orders_by_views_5_days_percentile".to_string(), "search__clicks_by_views_28_days_percentile".to_string(), "search__clicks_by_views_1_days_percentile_bin".to_string(), "search__orders_by_views_14_days_percentile".to_string(), "log_reviews".to_string(), "price_change_percent_dec".to_string(), "rating_30day".to_string(), "price_change_percent_inc".to_string(), "cancel_percent".to_string(), "price_diff_with_p70".to_string(), "rating_90day".to_string(), "asp".to_string(), "final_nqd".to_string(), "diff_bw_asp_and_arp".to_string(), "avg_rating".to_string(), "rto_percent".to_string(), "return_percent".to_string(), "odnr_score".to_string(), "rating_60day".to_string(), "sscat_price_clicks_by_views_56day_percentile_bin_percentage".to_string(), "sscat_rating_orders_by_views_56day_percentile_bin_percentage".to_string(), "rating_orders_56day_percentile".to_string(), "sscat_rating_clicks_by_views_56day_percentile_bin_percentage".to_string(), "rating_views_56day_percentile".to_string(), "sscat_price_orders_by_views_56day_percentile_bin_percentage".to_string(), "catalog_rating".to_string(), "sscat_price_orders_by_clicks_56day_percentile_bin_percentage".to_string(), "price_clicks_56day_percentile".to_string(), "price_orders_56day_percentile".to_string(), "sscat_rating_orders_by_clicks_56day_percentile_bin_percentage".to_string(), "price_views_56day_percentile".to_string(), "rating_clicks_56day_percentile".to_string(), "catalog__platform_orders_by_views_14_days__te_laplace".to_string(), "orders_by_clicks_laplace_1day".to_string(), "orders_by_views_laplace_28day".to_string(), "orders_by_views_laplace_7day".to_string(), "orders_by_views_laplace_3day".to_string(), "orders_by_clicks_laplace_5day".to_string(), "clicks_by_views_laplace_1day".to_string(), "clicks_by_views_laplace_5day".to_string(), "orders_by_views_laplace_56day".to_string(), "orders_by_clicks_laplace_28day".to_string(), "orders_by_clicks_laplace_3day".to_string(), "orders_by_views_laplace_1day".to_string(), "clicks_by_views_laplace_7day".to_string(), "clicks_by_views_laplace_28day".to_string(), "orders_by_clicks_laplace_56day".to_string(), "orders_by_clicks_laplace_7day".to_string(), "orders_by_views_laplace_5day".to_string(), "clicks_by_views_laplace_56day".to_string(), "clicks_by_views_laplace_3day".to_string(), "catalog__platform_carts_3_days__te_log".to_string(), "catalog__platform_carts_1_days__te_log".to_string(), "catalog__platform_carts_14_days__te_log".to_string(), "catalog__no_by_go_56_days".to_string(), "gross_orders".to_string(), "net_orders".to_string(), "catalog__per_return".to_string(), "cancellations".to_string(), "catalog__nqd_56_days".to_string(), "catalog__nqd_90_days".to_string(), "catalog__per_qr_return".to_string(), "catalog__avg_rating".to_string(), "catalog__no_by_go_7_days".to_string(), "catalog__no_by_go_28_days".to_string(), "catalog__no_by_go_90_days".to_string(), "search__sale_discount_factor_1".to_string(), "search__sale_discount_factor_2".to_string(), "clp__sale_discount_factor_2".to_string(), "clp__sale_discount_factor_1".to_string(), "pdp__sale_discount_factor_2".to_string(), "pdp__sale_discount_factor_1".to_string(), "ads_predicted_obyc_new_catalogs".to_string(), "ads_ds_predicted_target_roi_v1".to_string(), "ads_product_predicted_target_roi_v1".to_string(), "shipped_rto_rate_6m".to_string(), "shipped_rto_rate_3m".to_string(), "rate_6m".to_string(), "rate_6m".to_string(), "rate_3m".to_string(), "catalog__search_orders_by_clicks_28_days_percentile".to_string(), "catalog__search_clicks_by_views_28_days_percentile".to_string(), "catalog__search_views_3_days__te_log".to_string(), "predicted_net_orders_by_gross_orders".to_string(), "predicted_net_orders_by_gross_orders_smoothened_calibrated".to_string(), "predicted_net_orders_by_gross_orders_smoothened".to_string(), "views_3day".to_string(), "views_28day".to_string(), "orders_28day".to_string(), "clicks_5day".to_string(), "te_cbyv_7day".to_string(), "te_obyv_7day".to_string(), "te_obyv_3day".to_string(), "orders_5day".to_string(), "te_obyv_3day".to_string(), "te_obyc_7day".to_string(), "clicks_28day".to_string(), "clicks_1day".to_string(), "te_cbyv_3day".to_string(), "te_obyc_28day".to_string(), "te_cbyv_3day".to_string(), "clicks_56day".to_string(), "orders_56day".to_string(), "views_56".to_string(), "te_cbyv_56".to_string(), "rated_orders_sscat_percentile".to_string(), "views_7day".to_string(), "rated_orders_sscat_percentile_bin".to_string(), "orders_1day".to_string(), "views_56day".to_string(), "orders_1day".to_string(), "clicks_28day".to_string(), "te_cbyv_28day".to_string(), "orders_5day".to_string(), "max_price_sscat_percentile".to_string(), "te_obyc_56day".to_string(), "clicks_1day".to_string(), "rating".to_string(), "te_cbyv_28day".to_string(), "clicks_5day".to_string(), "te_obyc_56".to_string(), "te_obyv_56day".to_string(), "views_28day".to_string(), "views_1day".to_string(), "clicks_56day".to_string(), "te_obyc_5day".to_string(), "te_obyv_56".to_string(), "te_obyc_28day".to_string(), "te_cbyv_56".to_string(), "te_cbyv_56day".to_string(), "views_7day".to_string(), "te_obyc_3day".to_string(), "te_obyc_1day".to_string(), "max_price_sscat_percentile_bin".to_string(), "orders_56".to_string(), "te_cbyv_7day".to_string(), "clicks_7day".to_string(), "te_obyv_5day".to_string(), "orders_3day".to_string(), "te_obyv_1day".to_string(), "te_cbyv_5day".to_string(), "views_1day".to_string(), "te_cbyv_5day".to_string(), "te_cbyv_1day".to_string(), "min_price_sscat_percentile_bin".to_string(), "views_5day".to_string(), "clicks_3day".to_string(), "te_obyc_56".to_string(), "orders_56".to_string(), "orders_7day".to_string(), "te_obyv_5day".to_string(), "min_price_sscat_percentile".to_string(), "te_obyv_1day".to_string(), "te_obyv_56".to_string(), "te_cbyv_1day".to_string(), "clicks_56".to_string(), "te_obyv_56day".to_string(), "te_obyv_28day".to_string(), "te_obyv_28day".to_string(), "views_56day".to_string(), "clicks_56".to_string(), "views_5day".to_string(), "orders_28day".to_string(), "views_3day".to_string(), "views_56".to_string(), "te_obyc_3day".to_string(), "orders_3day".to_string(), "te_obyc_7day".to_string(), "orders_7day".to_string(), "te_cbyv_56day".to_string(), "clicks_3day".to_string(), "orders_56day".to_string(), "te_obyv_7day".to_string(), "te_obyc_5day".to_string(), "clicks_7day".to_string(), "te_obyc_1day".to_string(), "te_obyc_56day".to_string(), "log_28day".to_string(), "log_28day".to_string(), "laplace_1day".to_string(), "rating_30day".to_string(), "diff_asp_arp".to_string(), "laplace_7day".to_string(), "laplace_28day".to_string(), "log_7day".to_string(), "log_1day".to_string(), "28day".to_string(), "log_7day".to_string(), "rating_60day".to_string(), "log_1day".to_string(), "laplace_14day".to_string(), "log_7day".to_string(), "log_14day".to_string(), "log_28day".to_string(), "log_28day".to_string(), "log_14day".to_string(), "log_1day".to_string(), "56day".to_string(), "laplace_14day".to_string(), "laplace_7day".to_string(), "log_7day".to_string(), "laplace_1day".to_string(), "rating_90day".to_string(), "asp".to_string(), "laplace_28day".to_string(), "nqd_boosting_factor_gbm_model_v1".to_string(), "nqd_boosting_factor_gbm_model_v0".to_string(), "clp_price_aov_boosting_factor_var2".to_string(), "clp_price_aov_boosting_factor_var1".to_string(), "clp_price_aov_boosting_factor_var4".to_string(), "clp_price_aov_boosting_factor_var3".to_string(), "loyalty_boosting_factor".to_string(), "asp_p70_adj_30day".to_string(), "arp_p70_adj_30day".to_string(), "orders_by_clicks_bayesian".to_string(), "clicks_by_views_bayesian".to_string(), "orders_by_views_bayesian".to_string(), "orders_by_views_28day".to_string(), "clicks_by_views_28day".to_string(), "clicks_by_views_7day".to_string(), "orders_by_clicks_28day".to_string(), "clicks_by_views_3day".to_string(), "clicks_by_views_1day".to_string(), "clicks_by_views_14day".to_string(), "orders_by_views_1day".to_string(), "clp_odnr_sale_boosting_factor".to_string(), "net_order_by_gross_order".to_string(), "net_order_by_gross_order_smoothened".to_string(), "clp_odnr_sale_boosting_factor_var2".to_string(), "scaledup_boosting_factor".to_string(), "vrs_boosting_factor".to_string(), "nqd_boosting_factor_analytical_v2".to_string(), "search_odnr_sale_boosting_factor".to_string(), "nqd_boosting_factor".to_string()]
}

#[tokio::main(flavor = "multi_thread", worker_threads = 4)]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    println!("Connecting to feature store 1...");

    let channel = Endpoint::from_static("http://online-feature-store-api.int.meesho.int:80")
        .timeout(Duration::from_secs(10))
        .http2_keep_alive_interval(Duration::from_secs(30))
        .keep_alive_timeout(Duration::from_secs(10))
        .keep_alive_while_idle(true)
        .connect()
        .await?;

    let client = RetrieveClient::new(channel);
    
    // Pre-build static parts once at startup using Arc for sharing
    // This allows multiple owners without cloning string data - similar to Go's string literals!
    let feature_labels = Arc::new(get_labels());
    
    let state = Arc::new(AppState {
        client,
        entity_label: "catalog".to_string(),
        feature_group: FeatureGroup {
            label: "derived_fp32".to_string(),
            feature_labels: (*feature_labels).clone(),
        },
        keys_schema: vec!["catalog_id".to_string()],
        auth_token: AsciiMetadataValue::from_static("atishay"),
        caller_id: AsciiMetadataValue::from_static("test-3"),
    });

    let app = Router::new()
        .route("/retrieve-features", post(retrieve_features))
        .with_state(state);

    println!("Starting rust-caller-new on http://0.0.0.0:8080");
    let listener = tokio::net::TcpListener::bind("0.0.0.0:8080").await?;
    axum::serve(listener, app).await?;

    Ok(())
}


